name: Deploy to live website

on:
  # Runs on pushes targeting the default branch
  push:
    tags:
      - '*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
#permissions:
#  contents: read
#  pages: write
#  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Upgrade pip
        run: |
          # install pip=>20.1 to use "pip cache dir"
          python3 -m pip install --upgrade pip
          python3 -m pip -V

      - name: Get pip cache dir
        id: pip-cache
        run: echo "PIP_CACHE_DIR=$(pip cache dir)" | tee -a "${GITHUB_OUTPUT}"

      - uses: actions/cache@v3
        with:
          path: ${{ steps.pip-cache.outputs.PIP_CACHE_DIR }}
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: python3 -m pip install -r ./requirements.txt

      - run: mkdocs build --config-file ./mkdocs.yml

      - run: mkauthdocs maas mobidrom site/ --heading "Login to Maas NRW Wiki Demo Site"

      - uses: actions/upload-artifact@v2
        with:
          name: website
          path: site/

      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: mkdocs-wiki-test.roeglin-data.de
          protocol: ftps
          username: mkdocs-wiki-test
          password: ${{ secrets.ftps_password }}
          local-dir: site/

  deploy-live:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    needs: prepare
    environment: 'Live deployment'
    steps:
    - uses: actions/checkout@v2

    - uses: actions/download-artifact@v2
      with:
        name: website
        path: site/
      
    - name: ðŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: mkdocs-wiki-test.roeglin-data.de
        protocol: ftps
        username: mkdocs-wiki-test
        password: ${{ secrets.ftps_password }}
        local-dir: site/
